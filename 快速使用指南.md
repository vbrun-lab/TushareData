# 🚀 A股量化数据下载程序 - 快速使用指南

## 🎯 5分钟快速上手

### 第一步：环境准备
1. **安装依赖**：确保已安装Python和相关包
   ```bash
   pip install pandas tushare pathlib pyarrow  # pyarrow用于Parquet格式支持
   ```

2. **配置Token**：设置Tushare访问令牌
   
   如果项目中没有 `config.json` 文件，需要从模板文件创建：
   ```bash
   # 复制配置文件模板
   cp config.json.example config.json
   ```
   
   然后编辑 `config.json`，将 `YOUR_TOKEN_HERE` 替换为你的真实 Tushare token：
   ```json
   {
     "tushare_token": "你的真实token",
     ...
   }
   ```
   
   > 💡 **提示**：`config.json` 包含敏感信息，已被 `.gitignore` 忽略，不会提交到版本控制系统。

3. **检查网络**：确保网络连接稳定

### 第二步：首次运行
```bash
python start.py
```
选择 **[1] 更新基础数据** - 这是必须的第一步！

### 第三步：测试下载
选择 **[b] 配置驱动下载** - 小规模测试各类数据是否正常

### 第四步：正式使用
根据需要选择具体的数据类型进行下载

## 💡 两种使用方式

### 🖱️ 交互式界面（推荐新手）
```bash
python start.py
```
- 友好的菜单界面
- 实时进度显示
- 错误提示清晰

### ⌨️ 命令行模式（推荐高级用户）
```bash
# 增量模式下载ETF数据并退出
python start.py --incremental --20

# 全量模式下载完整数据流程
python start.py --full --12340

# 自定义时间范围下载
python start.py --custom --2

# 使用 main.py 按日期范围下载A股日线数据（示例：2019-01-01 ~ 2025-12-31）
python main.py --all-stocks --frequencies daily --start-date 20190101 --end-date 20251231
```

**命令行参数说明**：
- `--incremental`：增量更新模式
- `--full`：全量下载模式  
- `--custom`：自定义时间范围模式
- `--123450`：数字序列表示菜单操作顺序

## 📋 菜单功能详解

### 基础数据管理
- **[1] 更新基础数据** - 📊 首次使用必须执行，更新股票、基金、指数列表
- **[0] 退出程序** - 🚪 安全退出程序

### 日线数据下载
- **[2] 基金日线数据（ETF+LOF）** - 📈 下载所有基金日线行情（推荐优先下载）
- **[3] A股日线数据** - 📈 下载股票日线行情（数据量大）
- **[4] 指数日线数据** - 📈 下载指数日线行情

### 分钟线数据下载 ⭐ **新功能**
- **[5] 基金1分钟数据（ETF+LOF）** - ⏰ 下载所有基金分钟线（高频数据）
- **[6] A股 1分钟数据** - ⏰ 下载股票分钟线（数据量极大）
- **[7] 指数1分钟数据** - ⏰ **新增**：下载指数分钟线数据

### 高级功能
- **[a] 自定义下载** - ⚙️ 自定义选择股票代码和数据频率
- **[b] 配置驱动下载** - 🧪 根据config.json配置批量下载（推荐测试使用）
- **[c] 补齐缺失的分钟数据** - 🔧 检查并补齐未下载的股票1分钟数据
- **[d] 分钟数据健康检查** - 📊 生成分钟数据健康检查报告

### 🚀 智能批量执行
支持一次性输入多个选项编号来批量执行操作：

**基础用法**：
- `1` - 单独执行更新基础数据
- `12` - 依次执行：更新基础数据 → 基金日线数据
- `123` - 依次执行：更新基础数据 → 基金日线 → A股日线

**实用组合**：
- `1b0` - 更新基础数据 → 配置驱动下载 → 退出（推荐首次使用）
- `1234` - 下载所有日线数据（基金、股票、指数）
- `12340` - 下载所有日线数据后自动退出
- `123b0` - 下载日线数据 → 配置驱动下载 → 退出

**完整流程**：
- `12345670` - 下载所有数据类型后退出（数据量巨大，谨慎使用）

## 🆕 版本1.0新功能

### 📊 数据格式选择
程序根据数据类型**自动选择**最优保存格式，无需手动配置：

| 数据类型 | 保存格式 | 说明 |
|---------|---------|------|
| **基础数据** | CSV | 股票列表、基金列表、交易日历等参考数据 |
| **日线数据** | CSV | 日线行情数据，便于查看和分析 |
| **分钟数据** | Parquet | 分钟线数据，自动使用Parquet格式，大幅减少存储空间 |

**格式对比**：
| 格式 | 优势 | 劣势 | 适用场景 |
|------|------|------|----------|
| CSV | 兼容性好，可读性强 | 文件较大，读取较慢 | 基础数据、日线数据、调试分析 |
| Parquet | 压缩率高，读取快速 | 需要专门库支持 | 分钟数据、大规模数据、生产环境 |

> ⚠️ **注意**：配置文件中的 `data_format` 字段当前未被使用，程序会根据文件路径自动判断数据类型并选择相应格式。

### ⚡ 突破分钟数据限制
**智能分批下载算法**：
- 自动按月分批获取分钟数据，突破单次8000条限制
- 支持跨年边界处理，单个批次失败不影响整体
- 自动拼接、去重、降序排列，确保数据完整性

### 📈 后复权算法 ⭐ **重要改进**
**从前复权改为后复权**：
- **前复权问题**：新数据会影响历史价格，不适合增量更新
- **后复权优势**：历史数据不变，新数据不影响已有数据
- **增量友好**：确保增量模式下数据一致性

### 🎯 指数分钟数据支持
**新增指数分钟数据下载**：
- 支持主要指数和全部指数的分钟数据
- 与股票、基金分钟数据使用相同的分批算法
- 完整的交互式菜单支持

### 🔧 自定义Tushare连接
**支持自定义数据源**：
```json
{
  "tushare_url": ""  // 空字符串使用默认Tushare官方服务器 (https://tushare.pro/)
  // "tushare_url": "https://tushare.pro/"  // 也可以显式指定官方服务器
  // "tushare_url": "your_custom_url"  // 或使用自定义服务器地址
}
```

## 📋 推荐使用流程

### 🆕 首次使用（完整流程）
```bash
# 方式1：交互式（推荐新手）
python start.py
# 输入：1b0

# 方式2：命令行（推荐高级用户）
python start.py --incremental --1b0
```

**详细步骤**：
1. **更新基础数据** - 获取最新的股票、基金、指数列表
2. **配置驱动下载** - 根据配置小规模测试各类数据下载
3. **自动退出** - 测试完成后退出程序

### 🔄 日常增量更新
```bash
# 快速更新所有日线数据
python start.py --incremental --12340

# 只更新基金数据
python start.py --incremental --120

# 包含指数分钟数据
python start.py --incremental --1237
```

### 📦 全量数据下载
```bash
# 首次建库（数据量大，需要较长时间）
python start.py --full --12340

# 包含分钟线数据（数据量极大）
python start.py --full --12345670

# 直接使用命令行按日期范围全量下载A股日线（适合明确时间段的回测）
python main.py --all-stocks --frequencies daily --start-date 20190101 --end-date 20251231
```

### 🎯 特定场景使用

**只需要基金数据**：
```bash
python start.py --incremental --1250
```

**量化回测准备**：
```bash
python start.py --full --12340
```

**高频交易数据**：
```bash
python start.py --incremental --15670
```

**指数策略研究**：
```bash
python start.py --incremental --1470
```

## ⚠️ 重要注意事项

### 📋 使用前准备

#### 配置文件设置
1. **创建配置文件**：如果项目中没有 `config.json`，需要从模板创建：
   ```bash
   cp config.json.example config.json
   ```

2. **配置Token**：编辑 `config.json`，将 `YOUR_TOKEN_HERE` 替换为你的真实 Tushare token
   - 获取Token：访问 [Tushare官网](https://tushare.pro/) 注册并获取API token
   - 配置文件位置：项目根目录下的 `config.json`
   - 安全提示：`config.json` 包含敏感信息，不会被提交到Git仓库

#### 其他准备事项
- **网络环境**：建议在稳定的网络环境下进行长时间下载
- **存储空间**：全量下载需要10GB+存储空间，分钟线数据需要100GB+
- **依赖包**：使用Parquet格式需要安装`pyarrow`包

### 📊 数据量参考（更新）
| 数据类型 | 数据量级 | 下载时间 | 存储空间（CSV） | 存储空间（Parquet） |
|---------|---------|---------|----------------|-------------------|
| 基础数据 | 小 | 1-2分钟 | <10MB | <5MB |
| 基金日线（ETF+LOF） | 中 | 5-10分钟 | 100-500MB | 50-200MB |
| 股票日线 | 大 | 30-60分钟 | 2-5GB | 1-2GB |
| 基金分钟线（ETF+LOF） | 大 | 1-2小时 | 5-10GB | 2-4GB |
| 股票分钟线 | 极大 | 5-10小时 | 50-100GB | 20-40GB |
| 指数分钟线 | 中 | 30-60分钟 | 1-3GB | 500MB-1GB |

### 🚨 常见问题避免
- **首次使用必须先执行[1]更新基础数据**，否则无法下载行情数据
- **分钟线数据量极大**，建议先用[b]配置驱动下载验证功能
- **网络中断**时程序会自动重试，但建议在稳定网络环境下使用
- **API积分不足**时会自动跳过，不会影响其他数据下载
- **Parquet格式**需要安装pyarrow包：`pip install pyarrow`

## 📊 数据存储位置

下载的数据会按以下结构保存：
```
TushareData/
├── config.json           # 配置文件（包含敏感信息）
├── config.json.example   # 配置文件模板
├── data/                 # 历史行情数据（data_root配置的目录，默认./data）
│   ├── reference/        # 基础数据（股票列表等）
│   │   ├── stock_basic.csv   # 股票基础信息
│   │   ├── fund_basic.csv    # 基金基础信息
│   │   ├── index_basic.csv   # 指数基础信息
│   │   └── trade_cal.csv     # 交易日历
│   ├── data/            # 历史行情数据
│   │   ├── equities/    # 股票数据
│   │   │   ├── daily/        # 日线数据（CSV格式）
│   │   │   ├── minute_1/     # 1分钟数据（Parquet格式）
│   │   │   └── minute_5/      # 5分钟数据（Parquet格式）
│   │   ├── funds/       # 基金数据
│   │   │   ├── daily/        # 日线数据（CSV格式）
│   │   │   └── minute_1/     # 1分钟数据（Parquet格式）
│   │   └── indices/     # 指数数据
│   │       ├── daily/        # 日线数据（CSV格式）
│   │       └── minute_1/     # 1分钟数据（Parquet格式）
│   └── meta/            # 同步状态记录
│       ├── last_sync_equities_daily.csv
│       ├── last_sync_funds_daily.csv
│       └── last_sync_indices_daily.csv
└── logs/                # 下载日志
    └── YYYYMMDD_download.log
```

## 🔧 高级功能

### 配置文件自定义
编辑 `config.json` 可以自定义：
- **连接设置**：自定义Tushare服务器地址
- **筛选条件**：按上市日期、退市状态等筛选
- **下载模式**：INCREMENTAL（增量）、FULL（全量）、CUSTOM（自定义）
- **API参数**：调用频率、重试次数等
- **数据格式**：⚠️ 注意：数据格式由程序根据数据类型自动选择，无需配置

### 数据更新模式
- **INCREMENTAL**：只下载新增数据，速度快，适合日常更新
- **FULL**：重新下载所有数据，确保完整性，适合首次建库
- **CUSTOM**：按配置的时间范围和筛选条件下载，适合特定需求

### 智能分批算法
- **按月分批**：自动将大时间范围拆分为月度批次
- **错误隔离**：单个批次失败不影响其他批次
- **数据完整性**：自动拼接、去重、排序处理

### 后复权算法
- **算法改进**：从前复权改为后复权，确保历史数据稳定
- **增量友好**：新数据不会影响已下载的历史数据
- **数据一致性**：同一日期的复权价格在不同下载时间保持一致

### 错误恢复
- 程序支持断点续传，意外中断后可继续下载
- 自动重试机制处理网络异常
- 详细日志记录便于问题诊断

## 🔧 工具脚本

### 分钟数据健康检查报告

生成分钟数据的完整健康检查报告，包括：
- 基础状态检查（总股票数、已下载数、完成率）
- 数据时间范围分析（起始/结束日期分布、记录数统计）
- 异常检测（起始日期异常、记录数异常）
- 元数据文件检查
- 数据完整性分析
- 补齐建议

**使用方法**：
```bash
python minute_data_report.py
```

### 补齐缺失的分钟数据

自动检查并补齐未下载的股票1分钟数据。

**使用方法**：
```bash
# 命令行方式
python main.py --fill-missing-minutes

# 或使用交互式菜单
python start.py
# 选择 [c] 补齐缺失的分钟数据
```

**功能说明**：
- 自动检测哪些股票还没有1分钟数据
- 分批下载（每批100只股票）
- 使用现有的下载逻辑，确保数据一致性
- 自动更新元数据文件

## 🆘 常见问题解决

### Q: 提示"tushare_token未设置"或"配置文件不存在"
**A**: 
1. 如果项目中没有 `config.json` 文件，需要从模板创建：
   ```bash
   cp config.json.example config.json
   ```
2. 编辑 `config.json` 文件，将 `YOUR_TOKEN_HERE` 替换为你的真实 Tushare token
3. 获取Token：访问 [Tushare官网](https://tushare.pro/) 注册并获取API token

### Q: 下载速度很慢
**A**: 
1. 检查网络连接是否稳定
2. 可以调整`config.json`中的`sleep_secs`参数
3. 使用增量模式而非全量模式
4. 考虑使用Parquet格式提高I/O性能

### Q: 某些股票没有数据
**A**: 
1. 部分股票可能已退市或暂停交易
2. 检查筛选配置是否过于严格
3. 查看日志文件了解具体原因

### Q: 存储空间不足
**A**: 
1. 可以只下载需要的数据类型
2. 使用筛选配置减少下载数量
3. 使用Parquet格式减少存储空间
4. 定期清理不需要的历史数据

### Q: 分钟数据下载失败
**A**:
1. 检查是否有足够的API积分
2. 确认网络连接稳定
3. 查看日志了解具体错误信息
4. 程序会自动重试，可以重新运行

### Q: 如何切换数据格式
**A**:
1. ⚠️ **注意**：数据格式由程序根据数据类型自动选择，无法通过配置切换
2. 基础数据和日线数据固定使用CSV格式
3. 分钟数据固定使用Parquet格式
4. 如需转换格式，需要重新下载数据或使用外部工具转换

## 📞 技术支持

如需更多帮助，请参考：
- **详细文档**：`README.md`
- **配置说明**：`筛选配置说明.md`
- **项目架构**：`数据下载方案.md`

## 🎉 版本更新日志

### v1.0 主要更新
- ✅ **新增数据格式支持**：CSV和Parquet格式可选
- ✅ **突破分钟数据限制**：智能分批算法解决8000条限制
- ✅ **指数分钟数据**：完整支持指数分钟线下载
- ✅ **后复权算法**：改进复权计算，确保增量模式数据一致性
- ✅ **自定义连接**：支持自定义Tushare服务器地址
- ✅ **完善交互界面**：新增指数分钟数据菜单选项
- ✅ **智能错误处理**：增强网络异常和数据异常处理能力

---
**🎯 立即开始**: `python start.py` 